Updated Jun 7th, 2019

### Heightmap
While the spectra batch is processed, the algorithm writes in a separate file the net areas of the calculated peaks for the element(s) chosen. This file is useful for re-plotting an image if desired or to generate more data that takes these values as input, e.g. to calculate the thickness of an overlapping layer. The file is located under `'LOCAL_DISK:\installation_folder\output'`
Following the theory proposed by Cesareo, R. in a handful of papers, it is possible to estimate the thickness of a given overlapping layer by calculating the attenuation from characteristic lines of an element present in the underlying layer. This method has been extensively applied for a single or couple spectra and has proven accurate in certain situations.
The method requires a precise and accurate calculation of the peaks and a good estimation of the overlapping layer composition, as well as a good estimation of matrix effects. Some authors make use of a calibration curve generated from simulated data (Monte Carlo simulations) while others prefer to actually measure the _thick_ ratio (further information is available in references).
In general, the more complex the sample structure, the lower the accuracy is.
Nevertheless, the method has proven quite useful for measuring the thickness of goldleafs since their composition is easy to guess and corrections (if any) are usually done by just lowering the density of the overlapping layer in order to compensate porosity effects.
The thickness is given by the simplified equation: 

<br><img src="https://latex.codecogs.com/gif.latex?d&space;=&space;-\frac{sin(\psi)}{\left&space;[&space;\mu_{1}-\mu_{2}\right&space;]}&space;*&space;\left&space;[ln\left&space;(\frac{\left&space;(\frac{K_{\alpha}}{K_{\beta}}&space;\right&space;)_{M[i,j]}}{\left&space;(\frac{K_{\alpha}}{K_{\beta}}&space;\right&space;)_{thick}}&space;\right&space;)&space;\right&space;]" title="d = -\frac{sin(\psi)}{\left [ \mu_{1}-\mu_{2}\right ]} * \left [ln\left (\frac{\left (\frac{K_{\alpha}}{K_{\beta}} \right )_{M[i,j]}}{\left (\frac{K_{\alpha}}{K_{\beta}} \right )_{thick}} \right ) \right ]" /><br>

Where μ1 and μ2 are the linear total attenuation coefficients of the overlapping layer for the lines Kα and Kβ (or Lα and Lβ) of an element present in the underlying layer, respectively. Ψ is the incident beam angle (assuming the detector is at -Ψ) in degrees and <img src="https://latex.codecogs.com/gif.latex?\left&space;(K_{\alpha}K_{\beta}&space;\right&space;)_{M_{[i,j]}}" title="\left (K_{\alpha}K_{\beta} \right )_{M_{[i,j]}}" /> is the the value of element i,j of ratio matrix M, which in turn contains the Kα/Kβ ratios of the element under analysis from the underlying layer.
The inputs for generating the heightmap are, therefore, the ratio matrix M and the overlapping layer composition. The calculation is done for each element of matrix M. Since M represents data from the underlying layer, it is possible that calculations will be done for elements where there is no overlapping layer, e.g. in the case only a portion of the sample is covered (multi-layered). In this way, an elemental map of the most abundant² element present in the overlapping layer is used as a correction mask to avoid misscalculations.
<sub><br> _² The algorithm does not provide quantitative data in terms of sample composition, therefore, the most abundant element in this case is set according to the compound said to represent the overlapping layer composition._ </sub></br>

For now, a database with few compounds has been created to calculate the attenuation coefficients μ1 and μ2. If the overlapping layer is not mono-elemental, then the layer linear attenuation coefficient will be the weighted sum of the coefficients of the elements present within the layer, times the layer density. The database is written inside `Compounds.py` and uses attenuation coefficients from `EnergyLib.py`. Since this is still an experimental method, the coefficients for single elements were extracted from XCOM and written inside this algorithm library to save time, dismissing the need to calculate these values and being more "particular-case" oriented. So far coefficients for attenuations of Pb and Cu are implemented.

